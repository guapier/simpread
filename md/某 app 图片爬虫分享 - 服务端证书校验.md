> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [www.52pojie.cn](https://www.52pojie.cn/thread-1847904-1-1.html)

> [md]# å‰ç½®æˆ‘ä»¬ä»Šå¤©è¦ç ”ç©¶çš„æ˜¯ è·å– app çš„æ•°æ®è§£å¯†æ“ä½œï¼š## 1. è§£å†³æŠ“åŒ… é¦–å…ˆ å…ˆé€šè¿‡ä»£ {è¿‡}{æ»¤} ç† chlars æŠ“åŒ…ä¼šå‘ç°æŠ“ä¸åˆ°åŒ…ï¼Œæ‰“å¼€ socksDroid ä¸€æ ·æŠ“ä¸åˆ°åŒ…ã€‚

![](https://avatar.52pojie.cn/images/noavatar_middle.gif)miren66

å‰ç½®æˆ‘ä»¬ä»Šå¤©è¦ç ”ç©¶çš„æ˜¯ è·å– app çš„æ•°æ®è§£å¯†æ“ä½œï¼š

1. è§£å†³æŠ“åŒ…
-------

é¦–å…ˆ å…ˆé€šè¿‡ä»£ {è¿‡}{æ»¤} ç† chlars æŠ“åŒ…ä¼šå‘ç°æŠ“ä¸åˆ°åŒ…ï¼Œæ‰“å¼€ socksDroid ä¸€æ ·æŠ“ä¸åˆ°åŒ…ã€‚

æç¤ºï¼š400 No required SSL certificate was sent

é‚£ä¹ˆæˆ‘ä»¬å°±è¯¥è§£å†³è¿™ä¸ªæŠ“ä¸åˆ°é—®é¢˜ï¼Œä¸‡èƒ½çš„ç™¾åº¦è¿‡åï¼Œæœå¯»çŸ¥è¯†ï¼ˆéƒ¨åˆ†å€ŸåŠ©äºä½©å¥‡å¤§ä½¬çš„è¯¾ä»¶ï¼‰

### æœåŠ¡ç«¯è¯ä¹¦æ ¡éªŒ

*   å®¢æˆ·ç«¯æ ¡éªŒ
    
    ```
    - åœ¨å®¢æˆ·ç«¯ä¸­é¢„è®¾è¯ä¹¦ä¿¡æ¯
    - å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼Œå°†æœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦ä¿¡æ¯ï¼ˆå…¬é’¥ï¼‰å’Œå®¢æˆ·ç«¯é¢„è®¾è¯ä¹¦ä¿¡æ¯è¿›è¡Œæ ¡éªŒ
    
    ```
    
*   æœåŠ¡ç«¯æ ¡éªŒ
    
    ```
    - åœ¨å®¢æˆ·ç«¯é¢„è®¾è¯ä¹¦ï¼ˆp12/bksï¼‰
    - å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚æ—¶ï¼Œæºå¸¦è¯ä¹¦ä¿¡æ¯ï¼Œåœ¨æœåŠ¡ç«¯ä¼šæ ¡éªŒå®¢æˆ·ç«¯æºå¸¦è¿‡æ¥è¯ä¹¦çš„åˆæ³•æ€§
    
    ```
    

* * *

æœåŠ¡ç«¯è¯ä¹¦çš„æ ¡éªŒé€»è¾‘ï¼š

*   åœ¨ apk æ‰“åŒ…æ—¶ï¼Œå°†è¯ä¹¦ bks æˆ– p12 æ ¼å¼çš„è¯ä¹¦ä¿å­˜åœ¨ assets æˆ– raw ç­‰ç›®å½•ã€‚
    
*   å®‰å“ä»£ç ï¼Œå‘é€è¯·æ±‚æ—¶ ã€è¯»å–è¯ä¹¦æ–‡ä»¶å†…å®¹ã€‘+ ã€è¯ä¹¦å¯†ç ã€‘
    
    ![](https://picdl.sunbangyan.cn/2023/10/24/e71400c9bced211a3395993cf0ad31d5.png)
    

**é€†å‘æ—¶**ï¼Œéœ€è¦å®ç°ï¼š

*   è·å– bks æˆ– p12 è¯ä¹¦ æ–‡ä»¶
*   è·å–è¯ä¹¦ç›¸å…³å¯†ç 
*   å°†è¯ä¹¦å¯¼å…¥åˆ° charlesï¼Œå¯ä»¥å®ç°æŠ“åŒ…ï¼ˆbks æ ¼å¼éœ€è¦è½¬æ¢ p12 æ ¼å¼ï¼‰
*   ç”¨ requests å‘é€è¯·æ±‚æ—¶ï¼Œæºå¸¦è¯ä¹¦å»å‘é€è¯·æ±‚

é¦–å…ˆè·å– è¯ä¹¦å’Œè¯ä¹¦å¯†ç ï¼š

```
// hookå¯†ç å¯†ç 
Java.perform(function () {
Â  Â  var KeyStore = Java.use("java.security.KeyStore");

Â  Â  KeyStore.load.overload('java.io.InputStream', '[C').implementation = function (v1, v2) {
Â  Â Â  Â Â Â var pwd = Java.use("java.lang.String").$new(v2);
Â  Â Â  Â Â Â console.log('\n------------')
Â  Â Â  Â Â Â console.log("ç±»å‹ï¼š" + this.getType());
Â  Â Â  Â Â Â console.log("å¯†ç ï¼š" + pwd);
Â  Â Â  Â Â Â console.log(JSON.stringify(v1));
Â  Â Â  Â Â Â //console.log(Java.use("android.util.Log").getStackTraceString(Java.use("java.lang.Throwable").$new()));
Â  Â Â  Â Â Â var res = this.load(v1, v2);
Â  Â Â  Â Â Â return res;
Â  Â  };
});
// frida -U -f com.paopaotalk.im -l 1.hook_password.js
// 111111

```

å…·ä½“é€»è¾‘æ˜¯ hook java.security.KeyStore è¿™ä¸ªå¾—åˆ°è¯ä¹¦å¯†ç 

### Hook è¯ä¹¦æ–‡ä»¶

åœ¨å¼€å‘æ—¶ï¼Œæ˜¯å°†è¯ä¹¦æ–‡ä»¶åŠ è½½åˆ° `InputStream` å¯¹è±¡ä¸­ï¼Œåç»­å‘é€è¯·æ±‚æ˜¯ä¼šæºå¸¦ã€‚ã€‚ã€‚

è€Œæˆ‘ä»¬æƒ³è¦è·å–è¯ä¹¦å¯æœ‰ä¸¤ç§æ–¹å¼ï¼š

*   å®šä½ä»£ç ï¼Œæ‰¾åˆ°åŠ è½½è¯ä¹¦çš„æ–‡ä»¶è·¯å¾„ï¼Œç„¶åå» apk ä¸­å¯»æ‰¾ã€‚
    
*   ç›´æ¥ Hook è¯ä¹¦åŠ è½½ä½ç½®ï¼Œå°†è¯ä¹¦çš„å†…å®¹ä»`InputStream`å†™å…¥åˆ°è‡ªå®šä¹‰æ–‡ä»¶ï¼Œå®ç°è‡ªåŠ¨å¯¼å‡ºã€æ›´åŠ é€šç”¨ï¼Œç”šè‡³éƒ½ä¸éœ€è¦ä»»ä½•é€†å‘ã€‘ã€‚
    
    æ³¨æ„ï¼šæ‰‹æœºè¦å¯¹å½“å‰ APP å¼€å¯æœ¬åœ°ç¡¬ç›˜æ“ä½œæƒé™ã€‚
    
    ```
    Java.perform(function () {
    Â Â var KeyStore = Java.use("java.security.KeyStore");
    Â Â var String = Java.use("java.lang.String");
    
    Â Â KeyStore.load.overload('java.io.InputStream', '[C').implementation = function (inputStream, v2) {
    Â  Â Â  Â var pwd = String.$new(v2);
    Â  Â Â  Â console.log('\n------------')
    Â  Â Â  Â console.log("å¯†ç ï¼š" + pwd, this.getType());
    
    Â  Â Â  Â if (this.getType() === "pkcs12") {
    Â  Â Â  Â Â  Â  console.log("è¯ä¹¦å¼€å§‹å¯¼å‡º")
    Â  Â Â  Â Â  Â  var myArray = new Array(1024);
    Â  Â Â  Â Â  Â  for (var i = 0; i < myArray.length; i++) {
    Â  Â Â  Â Â  Â Â  Â Â Â myArray[i] = 0x0;
    Â  Â Â  Â Â  Â  }
    Â  Â Â  Â Â  Â  var buffer = Java.array('byte', myArray);
    
    Â  Â Â  Â Â  Â  var file = Java.use("java.io.File").$new("/sdcard/Download/meizhitu-" + new Date().getTime() + ".p12");
    Â  Â Â  Â Â  Â  var out = Java.use("java.io.FileOutputStream").$new(file);
    Â  Â Â  Â Â  Â  var r;
    Â  Â Â  Â Â  Â  while ((r = inputStream.read(buffer)) > 0) {
    Â  Â Â  Â Â  Â Â  Â Â Â out.write(buffer, 0, r);
    Â  Â Â  Â Â  Â  }
    Â  Â Â  Â Â  Â  console.log("save success!")
    Â  Â Â  Â Â  Â  out.close()
    Â  Â Â  Â }
    
    Â  Â Â  Â var res = this.load(inputStream, v2);
    Â  Â Â  Â return res;
    Â Â };
    
    });
    
    // frida -U -f com.mmzztt.app -l 2.hook_cert.js
    
    ```
    

è¿è¡Œåå¾—åˆ° ç»“æœå¦‚å›¾ï¼š å¯†é’¥Â Â uX39!dd$#rr_XIyb%

![](https://picst.sunbangyan.cn/2023/10/24/afd5b222189fa739ce609a450c928b5b.png)

var file = Java.use("java.io.File").$new("/sdcard/Download/meizhitu-" + new Date().getTime() + ".p12");

è¿™é‡Œé¢å¯ä»¥çœ‹åˆ° åœ¨å’±ä»¬çš„å®‰å“æ‰‹æœº è¿™ä¸ªè·¯å¾„å¯ä»¥çœ‹åˆ° è¯ä¹¦ã€‚

![](https://picss.sunbangyan.cn/2023/10/24/8525a6a7f5b0e226374e4ca0d9e3e13b.png)

ç°åœ¨æŠŠä»–æ”¾åˆ° chlars ä¸­

import p12

![](https://picst.sunbangyan.cn/2023/10/24/71c81c3edd6a7a493041fc15f3593e44.png)

è¾“å…¥å¯†ç ï¼š uX39!dd$#rr_XIyb%

![](https://picss.sunbangyan.cn/2023/10/24/ffd97c45265caae62f6d096022ef03a3.png)

![](https://picdm.sunbangyan.cn/2023/10/24/1af3f0417d41e38f58b04102a157c159.png)

ç°åœ¨å°±å¯ä»¥æ„‰å¿«çš„æŠ“åŒ…äº†ã€‚

![](https://picss.sunbangyan.cn/2023/10/24/47fdb028f63fea30bb588ddf6ee8c1a7.png)

2. è§£å¯† ç®—æ³•åŠ©æ‰‹å®šä½ï¼š
-------------

è¿™ä¸ªä¸ç”¨æˆ‘å¤šè¯´äº†å§ )

### ä¸€å®šè¦å…ˆæŠŠç›®æ ‡ app åå°æ¸…æ‰ã€‚

ä¸æ•¢æ”¾åŸå›¾ï¼ˆæ€•è¿è§„ï¼ï¼‰ï¼š

å¤åˆ¶ä¸€æ®µè¿”å›å€¼ å–ç®—æ³•åŠ©æ‰‹æ—¥å¿—å»æœç´¢ã€‚

![](https://picst.sunbangyan.cn/2023/10/24/ce4f4d95120c38b9dd175f226d4b4564.png)

å“¦ å¯†é’¥ å’Œ iv è¿˜æœ‰åŠ å¯†æ–¹å¼ å…¨ç»™å‡ºäº†åŒ…æ‹¬å †æ ˆï¼

![](https://picdm.sunbangyan.cn/2023/10/24/e1d6aec16f7e8b73cd133c071dcc821b.png)

![](https://picdm.sunbangyan.cn/2023/10/24/80e8dca8c2eb5e928ed9d4da731b1085.png)

### å¤šåˆ·æ–°ä¸€ä¸‹ appÂ Â æˆ‘ä»¬ä¼šå‘ç° iv æ˜¯å›ºå®šçš„ 0809060801020609 ä½†æ˜¯ key ä¸æ˜¯å›ºå®šçš„

é‚£ä¹ˆä¸‹ä¸€é˜¶æ®µå°±è¯¥åç¼–è¯‘ çœ‹çœ‹ å…·ä½“é€»è¾‘

åç¼–è¯‘ä¹‹å‰ å…ˆç»è¿‡æŸ¥å£³å·¥å…·ä¸€æŸ¥ 360 åŠ å£³

![](https://picss.sunbangyan.cn/2023/10/24/7ad88184a9a8300e99a6a2d6c3b301d0.png)

3. ç ¸å£³
-----

æˆ‘é¦–å…ˆä½¿ç”¨ frida dump è„±å£³å‘ç°è„±çš„ä¸æ˜¯å¾ˆå¹²å‡€ã€‚

ç„¶åæˆ‘é‡‡ç”¨Â Â çæƒœå¤§ä½¬çš„ fundexÂ Â å®Œæ•´è„±ä¸‹å£³

è„±å£³å…·ä½“æµç¨‹å°±ä¸åœ¨è¿™æ¼”ç¤ºäº†ç™¾åº¦ä¸€ä¸‹ éƒ½æœ‰ã€‚

![](https://picst.sunbangyan.cn/2023/10/24/114897551c486e481ed9ef506e7a4e51.png)  
![](https://picst.sunbangyan.cn/2023/10/24/60a0ff4ef15d9fd4ab81560c334ff49b.png)

4.jadx åç¼–è¯‘ ï¼‹frida hook
----------------------

### æ ¹æ®ç®—æ³•åŠ©æ‰‹çš„å †æ ˆå¯»æ‰¾å¹¶ä¸” hook

```
è§£å¯†Ivï¼ˆBase64ï¼‰ï¼šMDgwOTA2MDgwMTAyMDYwOQ==
è§£å¯†Ivï¼ˆHexï¼‰ï¼š30383039303630383031303230363039

è§£å¯†å†…å®¹ï¼ˆæ–‡æœ¬ï¼‰ï¼š=bÖï¿½ï¿½ï¿½|ï¿½ï¿½ï¿½Òï¿½ï¿½6ï¿½mï¿½}

Â  Â  at de.robv.android.xposed.XposedBridge$LegacyApiSupport.handleAfter(Unknown Source:33)
Â  Â Â  Â Â Â at J.callback(Unknown Source:292)
Â  Â Â  Â Â Â at LSPHooker_.doFinal(Unknown Source:11)
Â  Â Â  Â Â Â at com.apicloud.signature.AESUtils.decrypt(AESUtils.java:91)
Â  Â Â  Â Â Â at com.apicloud.signature.UzSignature.jsmethod_aesDecodeCBCSync_sync(UzSignature.java:566)
Â  Â Â  Â Â Â at java.lang.reflect.Method.invoke(Native Method)
Â  Â Â  Â Â Â at com.uzmap.pkg.uzcore.uzmodule.b$a.a(Unknown Source:2)
Â  Â Â  Â Â Â at com.uzmap.pkg.uzcore.uzmodule.b.a(Unknown Source:29)
Â  Â Â  Â Â Â at com.uzmap.pkg.uzcore.uzmodule.c.a(Unknown Source:21)
Â  Â Â  Â Â Â at com.uzmap.pkg.a.g.a(Unknown Source:2)
Â  Â Â  Â Â Â at com.uzmap.pkg.uzcore.uzmodule.a.f.a(Unknown Source:10)
Â  Â Â  Â Â Â at com.uzmap.pkg.uzcore.uzmodule.a.a.E(Unknown Source:54)
Â  Â Â  Â Â Â at com.uzmap.pkg.uzcore.uzmodule.a.a.a(Unknown Source:0)
Â  Â Â  Â Â Â at com.uzmap.pkg.a.e$a.a(Unknown Source:18)
Â  Â Â  Â Â Â at com.apicloud.b.a.a.a(Unknown Source:0)
Â  Â Â  Â Â Â at com.apicloud.a.c.a$3.invoke(Unknown Source:46)
Â  Â Â  Â Â Â at com.eclipsesource.v8.V8.callObjectJavaMethod(Unknown Source:18)
Â  Â Â  Â Â Â at com.eclipsesource.v8.V8._executeScript(Native Method)
Â  Â Â  Â Â Â at com.eclipsesource.v8.V8.executeScript(Unknown Source:0)
Â  Â Â  Â Â Â at com.eclipsesource.v8.V8.executeScript(Unknown Source:15)
Â  Â Â  Â Â Â at com.apicloud.a.c.v.a(Unknown Source:2)
Â  Â Â  Â Â Â at com.apicloud.a.c.v.b(Unknown Source:2)
Â  Â Â  Â Â Â at com.apicloud.a.c.t.a(Unknown Source:4)
Â  Â Â  Â Â Â at com.apicloud.a.c.g$2.run(Unknown Source:8)
Â  Â Â  Â Â Â at android.os.Handler.handleCallback(Handler.java:938)
Â  Â Â  Â Â Â at android.os.Handler.dispatchMessage(Handler.java:99)
Â  Â Â  Â Â Â at android.os.Looper.loop(Looper.java:223)
Â  Â Â  Â Â Â at android.app.ActivityThread.main(ActivityThread.java:7656)
Â  Â Â  Â Â Â at java.lang.reflect.Method.invoke(Native Method)
Â  Â Â  Â Â Â at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:592)
Â  Â Â  Â Â Â at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:947


```

![](https://picdl.sunbangyan.cn/2023/10/24/0b3dfc3c44165854d7cc66daf864be6a.png)

frida hook éªŒè¯ä½ç½®ï¼š

frida hook ä»£ç ï¼š

```
let AESUtils = Java.use("com.apicloud.signature.AESUtils");
AESUtils["decrypt"].overload('java.lang.String', '[B', '[B').implementation = function (str, bArr, bArr2) {
Â  Â  console.log(`AESUtils.decrypt is called: str=${str}, bArr=${bArr}, bArr2=${bArr2}`);
Â  Â  let result = this["decrypt"](str, bArr, bArr2);
Â  Â  console.log(`AESUtils.decrypt result=${result}`);
Â  Â  return result;
};

//æ³¨æ„è¿™é‡Œ å¯ä»¥ ä½¿ç”¨ ç»è¿‡ä¿®æ”¹ å¯ä»¥æ˜¾ç¤ºå­—èŠ‚æ•°ç»„
AESUtils.decrypt.overload('java.lang.String', '[B', '[B').implementation = function (str, bArr, bArr2) {
Â  Â  var byteArrayToStr = function (byteArray) {
Â  Â Â  Â  var result = "";
Â  Â Â  Â Â Â for (var i = 0; i < byteArray.length; i++) {
Â  Â Â  Â Â  Â Â  Â  result += String.fromCharCode(byteArray[i]);
Â  Â Â  Â Â  Â }
Â  Â Â  Â Â  Â Â Â return result;
Â  Â Â  Â };

Â  Â  console.log("AESUtils.decrypt is called: str=" + str + ", bArr=" + byteArrayToStr(bArr) + ", bArr2=" + byteArrayToStr(bArr2));
}


```

å‘ç°å°±æ˜¯è¿™é‡Œ ï¼ï¼

æ¥ç€åˆ†æÂ Â bArr, bArr2Â Â æ˜¯ key å’Œ iv å†å‘ä¸Šå¯»æ‰¾ å †æ ˆï¼š

at com.apicloud.signature.UzSignature.jsmethod_aesDecodeCBCSync_sync(UzSignature.java:566)

![](https://picss.sunbangyan.cn/2023/10/24/13abccbda884be6dc48cd2c0ec01624a.png)

`uZModuleContext.optString` æ˜¯ä¸€ä¸ªå¯èƒ½æ˜¯ç‰¹å®šåº“ã€æ¡†æ¶æˆ–åº”ç”¨ç¨‹åºä¸­çš„ä¸€ä¸ªå‡½æ•°è°ƒç”¨ã€‚è¿™ä¸ªå‡½æ•°é€šå¸¸ç”¨äºä»æŸä¸ªä¸Šä¸‹æ–‡æˆ–å¯¹è±¡ä¸­è·å–ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¦‚æœè¯¥å€¼ä¸å­˜åœ¨æˆ–ä¸º nullï¼Œåˆ™è¿”å›ä¸€ä¸ªé»˜è®¤å€¼ã€‚

æ¥ç€ hook optString

```
 `hook let UZModuleContext = Java.use("com.uzmap.pkg.uzcore.uzmodule.UZModuleContext");`
`UZModuleContext["optString"].overload('java.lang.String').implementation = function (str) {`
Â  Â  `console.log(UZModuleContext.optString is called: str=${str});`
Â  Â  `let result = this["optString"](str);`
Â  Â  `console.log(UZModuleContext.optString result=${result});`
Â  Â  `return result;`
`};

```

![](https://picss.sunbangyan.cn/2023/10/26/8253222735c80a7052a06bff672d9237.png)

![](https://picss.sunbangyan.cn/2023/10/26/8e838907ce1da701296e021901f6984d.png)

ä»–å‘é‡Œé¢æ·»åŠ äº† 73921Â Â --> è¿™é‡Œæ˜¯ å‚æ•°çš„è¿”å›å€¼ã€‚

![](https://picdl.sunbangyan.cn/2023/10/24/55e37b641b8148aa0788ffa3b41756c6.png)

73921Â  Â å¾—åˆ°Â Â b65ca9e9f5667139Â Â çŒœæµ‹ä¸€ä¸‹æ˜¯ä¸æ˜¯ md5

å…ˆæµ‹è¯•ä¸€æ³¢ï¼š

å¯¹æ¯”å‘ç°å°±æ˜¯Â Â md5 çš„ ä¸­é—´ 16 ä½

![](https://picdm.sunbangyan.cn/2023/10/24/18007fa6163d7f249a50001cd7eea843.png)

æ¥ç€å’±ä»¬ hook ä¸€ä¸‹ md5 å°± å¾—å‡º

åŠ å¯†æ–¹æ³•å…¶å®å°±æ˜¯ strÂ Â md5 å– 16 ä½å¾—å‡ºã€‚

ç»“å°¾æ’’èŠ±ï¼
-----

å°±æ˜¯ aes cbc iv å›ºå®š æ˜¯ 0809060801020609Â Â key æ˜¯ è¿”å›å€¼ çš„å‚æ•° ç»è¿‡ md5 åå–å¾— ä¸­é—´ 16 ä½å¾—å‡ºã€‚